---
execute: 
  echo: false
  warning: false
title: "Relatorio Parcial 1"
subtitle: "Daniel Barbosa"
author: "Lucas Castanheira e José Guilherme - FitoData"
date: '`r format(Sys.time(), "%d %B, %Y")`'
description: "Criando modelos para os dados"
title-block-banner: true
format:
 html: 
    embed-resources: true
    smooth-scroll: true
    theme: cosmo
    fontcolor: black
    toc: true
    toc-location: left
    toc-title: Summary
    toc-depth: 3
fontsize: 13pt
editor: visual
---

```{r}
#| label: setup
#| include: false

# library
library(tidyverse)
library(readxl)
library(ggthemes)
library(knitr)
library(ggpubr)
library(gt)
library(lmtest)
library(DHARMa)
#
library(lme4)
library(MuMIn) # Para facilitar a comparação de modelos

dadosA_davis <- read_excel("../dados/Escala Davis/adavis-adapted.xlsx")

df_A_Davis <- dadosA_davis |> 
  mutate(
    # Criar uma coluna com a indentificação do tratamento
    Tratamento = factor(case_when(
      Adjuvante == "NA" & Taxa == "0" ~ "1",
      Adjuvante == "Aureo" & Taxa == "10" ~ "2",
      Adjuvante == "Silwet" & Taxa == "10" ~ "3",
      Adjuvante == "Ochima" & Taxa == "10" ~ "4",
      Adjuvante == "NA" & Taxa == "10" ~ "5",
      Adjuvante == "Aureo" & Taxa == "30" ~ "6",
      Adjuvante == "Silwet" & Taxa == "30" ~ "7",
      Adjuvante == "Ochima" & Taxa == "30" ~ "8",
      Adjuvante == "NA" & Taxa == "30" ~ "9",
      Adjuvante == "Aureo" & Taxa == "120" ~ "10",
      Adjuvante == "Silwet" & Taxa == "120" ~ "11",
      Adjuvante == "Ochima" & Taxa == "120" ~ "12",
      Adjuvante == "NA" & Taxa == "120" ~ "13"
      )),
    # reorganizar os fatores para ordem crescente de 1 a 13
    Tratamento = fct_relevel(
      Tratamento,
      "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13"),
    Bloco = factor(Bloco),
    Sub = factor(Sub))|> 
  # alongar df
  pivot_longer(names_to = "dias",
               values_to = "Severidade",
               cols = "3DAA":"7DAB") |> 
  mutate(dias = factor(dias),
         Adjuvante = factor(Adjuvante)) |> 
  rename(planta = "Sub") |> 
  #retirar valores NA
  drop_na()

# selecionar apenas o dia 3DAA
df_3DAA_A_Davis <- df_A_Davis |> 
  filter(dias == "3DAA") |> 
  mutate(Taxa = as.numeric(Taxa))
```

# Introdução

Os dados coletados da severidade (Escala Davis) e da contagem de plantas atacadas não seguem uma distribuição normal - conforme visto no gráfico abaixo. A melhor distribuição que se aplica ao dados é a distribuição de Poisson, que segue o seguinte modelo não linear log μ = β0+β1x .

```{r}
#| label: distribuicao-dia-3
#| fig-cap: "Figura 1: Distribuição das observações do nível de severidade pela Escala Davis."
df_3DAA_A_Davis |> 
  ggplot(aes(x = Severidade))+
  geom_histogram()+
  scale_x_continuous(breaks = c(0:9))+
  labs(x = "Severidade (Escala Davis)")
```

Para ajustar essa curva, criamos modelos lineares generalizados a fim de encontrar o modelo que melhor se adapte aos resultados, levando em consideração critérios como residual deviance e o AIC.

Estamos em fase de leitura e processamento para achar o melhor modelo que se ajuste aos seus dados.

Abaixo montamos um exemplo de como temos feito esse processo.

# Estatística

A fim de encontrar o modelo ideal, criamos modelos com diferentes níveis de complexidade para compará-los e verificar se há diferença entre eles. No fim das contas, queremos ficar com o modelo mais simples, desde que ele explique os dados da mesma forma que os mais complexos.

Para isso, seguimos os seguintes passos:

## 1) Elaborar modelos com diferentes níveis de complexidade

Estamos utilizando os dados de severidade medido pela Escala Davis. Pare esse exemplo, utilizamos apenas as observações feitas no dia "3DAA".

-   Modelo:

    -   Completo (Severidade \~ taxa_aplicacao_esc \* Adjuvante + (1 \| Bloco);

    -   Sem interação (Severidade \~ taxa_aplicacao_esc + Adjuvante + (1 \| Bloco);

    -   Apenas a Taxa (Severidade \~ taxa_aplicacao_esc + (1 \| Bloco);

    -   Apenas o Ajuvante (Severidade \~ Adjuvante + (1 \| Bloco);

```{r}
#| label: reescalonando-variavel-taxa
# Supondo que seu banco de dados esteja no data frame `dados`
# Variável resposta: `severidade` (medida pela escala Davis)
# Variáveis preditoras: `taxa_aplicacao` (taxa de aplicação de pesticida) e `adjuvante` (tipo de adjuvante)
# Variável aleatória: `bloco` (blocos casualizados)


# Reescalonamento da variável 'taxa_aplicacao'
df_3DAA_A_Davis$Taxa <- as.numeric(df_3DAA_A_Davis$Taxa)
taxa_media <- mean(df_3DAA_A_Davis$Taxa)
taxa_sd <- sd(df_3DAA_A_Davis$Taxa)
df_3DAA_A_Davis$taxa_aplicacao_esc <- as.factor((df_3DAA_A_Davis$Taxa - taxa_media) / taxa_sd )
```

```{r}
#| label: montando-modelos
#| include: false
# Modelo completo: Inclui todas as variáveis e a interação entre elas
modelo_completo <- glmer(Severidade ~ taxa_aplicacao_esc * Adjuvante + (1 | Bloco), 
                         data = df_3DAA_A_Davis, family = poisson(link = "log"))

# Modelos simplificados
modelo_sem_interacao <- glmer(Severidade ~ taxa_aplicacao_esc + Adjuvante + (1 | Bloco), 
                              data = df_3DAA_A_Davis, family = poisson(link = "log"))

modelo_apenas_taxa <- glmer(Severidade ~ taxa_aplicacao_esc + (1 | Bloco), 
                            data = df_3DAA_A_Davis, family = poisson(link = "log"))

modelo_apenas_adjuvante <- glmer(Severidade ~ Adjuvante + (1 | Bloco), 
                                 data = df_3DAA_A_Davis, family = poisson(link = "log"))

```

## 2) Comparação entre modelos

Utilizamos o Critério de Informação de Akaike (AIC) para comparar os modelos criados.

Quanto menor o AIC, melhor é o modelo.

```{r}
#| label: comparando-modelos
# Comparação dos modelos usando o critério de Akaike (AIC)
aic_modelos <- data.frame(
  Modelo = c("Completo", "Sem Interação", "Apenas Taxa", "Apenas Adjuvante"),
  AICc = c(AICc(modelo_completo), 
           AICc(modelo_sem_interacao), 
           AICc(modelo_apenas_taxa), 
           AICc(modelo_apenas_adjuvante))
)

# Ordena os modelos pelo AICc
aic_modelos <- aic_modelos[order(aic_modelos$AICc), ]

# Exibe os resultados da comparação dos modelos
print(aic_modelos)
```

## 3) Tomada de decisão

Pelo resultado acima, vemos que o modelo completo é o que melhor representa os dados. Por isso, seguimos com ele.

Abaixo temos as informações gerais abstraídas dele, das quais tiraremos nossas conclusões.

```{r}
#| label: escolha-do-melhor-modelo
# Seleciona o modelo com o menor AIC
melhor_modelo <- switch(aic_modelos$Modelo[1],
                        "Completo" = modelo_completo,
                        "Sem Interação" = modelo_sem_interacao,
                        "Apenas Taxa" = modelo_apenas_taxa,
                        "Apenas Adjuvante" = modelo_apenas_adjuvante)

# Resumo do melhor modelo
summary(melhor_modelo)
```

## 4) Grafico dos efeitos principais:

Abaixo temos um gráfico representando o compartamento geral da Severidade em função da taxa e adjuvante.

```{r}
#| label: gráfico-de-efeitos-principais
# Gráfico de efeitos principais (usando ggplot2 para visualização)
df_3DAA_A_Davis |> 
  ggplot(aes(x= Taxa, y =Severidade, color = Adjuvante)) +
    geom_point() +
    geom_jitter()+
    scale_x_continuous(breaks = c(0, 10, 30, 120))+
    scale_y_continuous(breaks = 0:9)+
    geom_smooth(method = "glm", method.args = list(family="poisson"), se=FALSE) +
    labs(title="Efeito da Taxa de Aplicação e Adjuvante na Severidade",
         subtitle = "Observação feita 3 dias após a primeira aplicação",
         x="Taxa de Aplicação de Pesticida",
         y="Severidade dos Danos (Escala Davis)") +
    theme_minimal()
```

Com base nesses resultados, conseguimos fazer as interpretações necessárias.

No momento, estamos comparando esse método com outros de transformação da variável resposta para avaliar qual melhor explica os dados.
