---
execute: 
  echo: false
  warning: false
title: "Relatorio Parcial 1"
subtitle: "Daniel Barbosa"
author: "Lucas Castanheira e José Guilherme - FitoData"
date: '`r format(Sys.time(), "%d %B, %Y")`'
description: "Criando modelos para os dados"
title-block-banner: true
format:
 html: 
    embed-resources: true
    smooth-scroll: true
    theme: cosmo
    fontcolor: black
    toc: true
    toc-location: left
    toc-title: Summary
    toc-depth: 3
fontsize: 13pt
editor: visual
---

```{r}
#| label: setup
#| include: false

# library
library(tidyverse)
library(readxl)
library(ggthemes)
library(knitr)
library(ggpubr)
library(gt)

dadosA_davis <- read_excel("../dados/Escala Davis/adavis-adapted.xlsx")

df_A_Davis <- dadosA_davis |> 
  mutate(
    # Criar uma coluna com a indentificação do tratamento
    Tratamento = factor(case_when(
      Adjuvante == "NA" & Taxa == "0" ~ "1",
      Adjuvante == "Aureo" & Taxa == "10" ~ "2",
      Adjuvante == "Silwet" & Taxa == "10" ~ "3",
      Adjuvante == "Ochima" & Taxa == "10" ~ "4",
      Adjuvante == "NA" & Taxa == "10" ~ "5",
      Adjuvante == "Aureo" & Taxa == "30" ~ "6",
      Adjuvante == "Silwet" & Taxa == "30" ~ "7",
      Adjuvante == "Ochima" & Taxa == "30" ~ "8",
      Adjuvante == "NA" & Taxa == "30" ~ "9",
      Adjuvante == "Aureo" & Taxa == "120" ~ "10",
      Adjuvante == "Silwet" & Taxa == "120" ~ "11",
      Adjuvante == "Ochima" & Taxa == "120" ~ "12",
      Adjuvante == "NA" & Taxa == "120" ~ "13"
      )),
    # reorganizar os fatores para ordem crescente de 1 a 13
    Tratamento = fct_relevel(
      Tratamento,
      "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13"),
    Bloco = factor(Bloco),
    Sub = factor(Sub))|> 
  # alongar df
  pivot_longer(names_to = "dias",
               values_to = "Severidade",
               cols = "3DAA":"7DAB") |> 
  mutate(dias = factor(dias),
         Adjuvante = factor(Adjuvante),
         # transformar taxa em fator
         Taxa = factor(Taxa)) |> 
  rename(planta = "Sub")

# selecionar apenas o dia 3DAA
df_3DAA_A_Davis <- df_A_Davis |> 
  filter(dias == "3DAA")
```

# Introdução

Os dados coletados da severidade (Escala Davis) e da contagem de plantas atacadas não seguem uma distribuição normal - conforme visto no gráfico abaixo. A melhor distribuição que se aplica ao dados é a distribuição de Poisson, que segue o seguinte modelo não linear log μ = β0+β1x .

```{r}
#| label: distribuicao-dia-3
#| caption: "Distribuição das observações do nível de severidade pela Escala Davis."
df_A_Davis |> 
  ggplot(aes(x = Severidade))+
  geom_histogram()+
  labs(x = "Severidade (Escala Davis)")
```

Para ajustar essa curva, criamos modelos lineares generalizados a fim de encontrar o modelo que melhor se adapte aos resultados, levando em consideração critérios com como residual deviance e o AIC.

Muitas das vezes a curva de distribuição de poisson é teórica, pois parte do pressuposto de que a média e a variância são idênticas. Caso isso não ocorra em seus dados, que é o mais provável, então usaremos uma curva de semi poisson. Que pode revelar pouca significância entre as variáveis preditoras do seu modelo, tanto entre os níveis quanto entre a interação.

Estamos em fase de leitura e processamento para achar o melhor modelo que se ajuste aos seus dados.

Abaixo montamos um exemplo de como temos feito esse processo.

# Estatística

## Processo de encontrar um modelo

```{r}
#| label: modelo_1

model_null <- glm(Severidade ~ 1, family = "poisson", df_A_Davis)
model1 <- glm(Severidade ~ Taxa*Adjuvante*Bloco, family = "poisson", df_A_Davis)

anova(model_null, model1, test = "Chisq")
```

Após montar um modelo com incluindo as variáveis Taxa, Adjuvante e Bloco, percebemos que o desvio do modelo 1 é menor que o do modelo nulo, indicando que precisamos de um modelo mais complexo que o nulo.

Agora comparamos a interação entre os tratamentos inclusos dentro do modelo 1. Fazemos isso para verificar a possibilidade de reduzir o modelo e deixá-lo mais simplificado.

```{r}
model2 <- glm(Severidade ~ Taxa*Adjuvante*Bloco, family = "quasipoisson", df_A_Davis)

anova(model2, test = "F")
```

Por meio desse resultado, vemos que todos os tratamentos apresentam diferença significativa. Para propor um modelo menos simplificado, então, excluiremos o tratamento com menor significância de interação.

```{r}
model3 <- glm(Severidade~Adjuvante*Bloco, family = "poisson", df_A_Davis)

anova(model2, model3, test = "F")
```

```{r}
model4 <- glm(Severidade~Adjuvante+Bloco+Taxa, family = "quasipoisson", df_A_Davis)

anova(model2, model4, test = "F")
```

```{r}
anova(model4, test = "F")
```

Grafico dos efeitos principais:

```{r}
#| label: gráfico-de-efeitos-principais
# Gráfico de efeitos principais (usando ggplot2 para visualização)
ggplot(df_3DAA_A_Davis, aes(x= Taxa, y=Severidade)) +
  geom_point(aes(color = Adjuvante)) +
  geom_jitter(aes(color = Adjuvante))+
  scale_x_continuous(breaks = c(0, 10, 30, 120))+
  scale_y_continuous(breaks = c(0,2,4,6,8,10))+
  geom_smooth(method = "glm", method.args = list(family="poisson"), se=FALSE) +
  labs(title="Efeito da Taxa de Aplicação e Adjuvante na Severidade",
       x="Taxa de Aplicação de Pesticida",
       y="Severidade dos Danos (Escala Davis)") +
  theme_minimal()
```
